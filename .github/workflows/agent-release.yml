name: Agent Release

on:
  push:
    tags:
      - 'agent-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: velocitypulse-agent

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/agent-v}"
          echo "version=$TAG" >> "$GITHUB_OUTPUT"
          echo "short_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Verify tag matches package.json
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "ERROR: Tag version (${{ steps.tag.outputs.version }}) does not match package.json ($PKG_VERSION)"
            exit 1
          fi

      - name: Verify tag matches version.ts
        run: |
          TS_VERSION=$(grep "export const VERSION" src/utils/version.ts | grep -oP "'[^']+'" | tr -d "'")
          if [ "$TS_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "ERROR: Tag version (${{ steps.tag.outputs.version }}) does not match version.ts ($TS_VERSION)"
            exit 1
          fi

      - name: Inject build ID
        run: |
          sed -i "s/__BUILD_ID__/${{ steps.tag.outputs.short_sha }}/g" src/utils/version.ts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: velocitypulse-agent/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Create release archives
        run: |
          VER="${{ steps.tag.outputs.version }}"
          STAGE_DIR="../velocitypulse-agent-${VER}"
          mkdir -p "$STAGE_DIR/src/ui"
          cp -r dist/ package.json package-lock.json "$STAGE_DIR/"
          cp -r src/ui/public/ "$STAGE_DIR/src/ui/"
          # tar.gz for Linux
          tar -czf "../velocitypulse-agent-${VER}.tar.gz" -C .. "velocitypulse-agent-${VER}"
          # zip for Windows
          cd .. && zip -rq "velocitypulse-agent-${VER}.zip" "velocitypulse-agent-${VER}"
        id: archive

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: agent-v${{ steps.tag.outputs.version }}
          name: VelocityPulse Agent v${{ steps.tag.outputs.version }}
          body: |
            ## VelocityPulse Agent v${{ steps.tag.outputs.version }}

            **Build:** `${{ steps.tag.outputs.short_sha }}`

            ### Installation

            **Linux:**
            ```bash
            curl -sSL https://get.velocitypulse.io/agent.sh | sudo bash
            ```

            **Windows (PowerShell as Admin):**
            ```powershell
            irm https://get.velocitypulse.io/agent | iex
            ```
          files: |
            velocitypulse-agent-${{ steps.tag.outputs.version }}.tar.gz
            velocitypulse-agent-${{ steps.tag.outputs.version }}.zip
